---
title: "Sandeel Area 1 Recruitment Forecast"
subtitle: 'Fishforecasts Forecast sheet 03-20181204'
output:
  word_document: 
    fig_caption: yes
    reference_docx: "../resources/word-styles-reference.docx"
  html_document: 
    fig_caption: yes
    outputfile: test.html
---

```{r setup, include="FALSE"}
this.issue <- "17-09-2018"

#Configure Knitr
knitr::opts_chunk$set(
  echo=FALSE,
	error = FALSE,
	fig.width = 10,
  fig.path="./figures/",
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	results = "markup"
)
knitr::opts_knit$set(
  root.dir="..")

library(tidyverse)
library(RColorBrewer)

```

```{r}
# htmltools::img(src = knitr::image_uri(file.path("..", "common","WGS2D_logo.png")), 
#                alt = 'logo', 
#                style = 'position:absolute; top:0; right:0; padding:10px;')
```
Issued 04-12-2018. Valid through to 1-04-2019. 

Prepared by Mark R. Payne, DTU Aqua, Copenhagen, Denmark. 

<!-- This forecast sheet superceeds the previous version 01-v02.1, issued 17-01-2018. For details, see the Change Log at the bottom of this document. -->

This is the final forecast of the 2018 cohort strength for this stock and superceeds a previous preliminary version released via Twitter 13 Nov 2018. A forecast verification summary will be issued to coincide with the release of advice on this stock in early 2019.


```{r }
#  Setup
#Configure markdown style, do house cleaning
rm(list = ls(all.names=TRUE));  graphics.off();
start.time <- proc.time()[3]; options(stringsAsFactors=FALSE)

#Helper functions, externals and libraries
library(tidyverse)
library(ggplot2)
library(tibble)
library(sf)
library(mapdata)
library(MuMIn)

#Configuration
theme_set(theme_bw(base_size = 14))

#Inline strings
forecast.yr <- 2018
most.recent.data <- "September 2018"
lead.time <- "2 months"


```

## Forecast
The forecast model suggests a low probability (20%) of the `r forecast.yr` year class being low (in the lower third of the historically observed recruitment) (Figure 1). There is a 50% chance of this year class being high.

```{r Fig_Forecast,fig.cap="**Figure 1. Historical recruitment time series and forecast** *Time series of recruitment to this stock are shown based on the raw estimates from the ICES HAWG working group (green line) and after making corrections for the observed bias of the stock assessment methodology. The probabilities of the 2018 year class falling in each of the three terciles (high, medium or low recruitment) are plotted as horizontal bars. Tercile thresholds are based on the (bias corrected) values from the first 30 years of the time series (1983-2012 inclusive).*"}
#'========================================================================
# Setup ####
#'========================================================================
norm.fact <- 1e6
mdl.sel <- "MuMIn_NoCPR_CoLin.RData"

#Import draws
load(file.path("objects","predictions",mdl.sel))

#Import assessment and ancillery data
load("objects/Assessment_comparisons.RData")

#Setup terciles
load("objects/terciles.RData")
terc <- exp(terc)/norm.fact

#Extract forecast
draws <- pred.draws.l[[as.character(forecast.yr)]]  #Note the the name here is the assment year name
forecast.draws <- tibble(x=forecast.yr,
                             y=exp(draws[,ncol(draws)])/norm.fact)
terc.probs <- c(lt=mean(forecast.draws$y<terc[1]),
                mt=mean(forecast.draws$y>terc[1] & forecast.draws$y<terc[2]),
                ut=mean(forecast.draws$y>terc[2]))
terc.labels <- tibble(x1=1980.25,x2=forecast.yr,
                       y.low=c(0,terc),
                       y.high=c(terc[1],terc[2],sum(terc)),
                       y=(y.low+y.high)/2,
                       lbl=factor(c("Low","Medium","High"),rev(c("Low","Medium","High"))),
                       prob.lbl=sprintf("%02i%%",round(terc.probs*10)*10),
                       x.max=x2+terc.probs*4)

#'========================================================================
# Visualise forecasts ####
#'========================================================================
rec.lims <- c(0,600)
ass.plt.dat <- filter(ass.comp.dat,variable=="Recruits") %>%
               mutate("Bias corrected"=exp(corrected.value)) %>%
               dplyr::select(-corrected.ul,-corrected.ll,-corrected.value) %>%
               rename("ICES HAWG"=value) %>%
               gather(key = "type",value = "value",-Year,-variable) %>%
               mutate(value=value/norm.fact)
#  geom_violin(data=forecast.draws,aes(x,y,fill="Forecast"),inherit.aes = FALSE)+
  # geom_vridgeline(data=forecast.draws,aes(x,y,width=..density..,fill="Forecast distribution"),
  #                 inherit.aes = FALSE,stat="ydensity",scale=1000)+



ggplot()+
  geom_rect(data=terc.labels,aes(xmin=x2,xmax=x.max,ymin=y.low,ymax=y.high,fill=lbl),colour="black")+
  geom_label(data=terc.labels,aes(x1,y,label=lbl,fill=lbl),hjust="left",show.legend = FALSE)+
  geom_text(data=terc.labels,aes(x.max,y,label=prob.lbl),
            hjust="left",nudge_x = 0.5)+
  geom_hline(yintercept = terc,linetype="dashed")+
  geom_line(data=ass.plt.dat,aes(Year,value,col=type))+
  scale_fill_brewer(palette = "BrBG")+
  scale_x_continuous(breaks=c(1980,1990,2000,2010,2018))+
  labs(x="Year class",y="Recruitment [10^9 indiv.]",colour="Recruitment",fill="Forecast Terciles")+
  coord_cartesian(expand=FALSE,ylim=rec.lims,xlim=c(1980,2025))+
  theme(panel.grid = element_blank())

```


## Background

Lesser sandeel (<i>Ammodytes marinus</i>) in the North Sea form the basis for a commercially important fishery, where they are used in the production of fishoil and fishmeal. The species lives on sandy banks distributed throughout the North Sea: while the adults are typically bound to a specific bank, larval sandeel are pelagic and drift between banks. Particle tracking studies (Christensen et al 2008) have characterised this connectivity pattern and form the basis for the definition of seven management units. The largest of these is Area 1, in the southern and south-western North Sea (Figure 2).
```{r Fig_Banks,fig.cap="**Figure 2. Sandeel areas and banks in the North Sea.** *Sandeel Area 1 is coloured with a pale pink colour and the boundary denoted by a red line. Sandeel banks are drawn as coloured polygons - those inside Area 1 are coloured red. Sandeel banks and boundaries of areas outside Area 1 are coloured grey.*"}
load("objects/Polygons.RData")

st_crs(SAN.polys) <- st_crs(banks.sf)
ggplot()+
  geom_sf(data=SAN.polys,fill=NA)+
  geom_sf(data=SAN1.sf,colour="red",size=1,fill="lightpink")+
  annotation_map(map_data("worldHires"),fill="black")+
  geom_sf(data=banks.sf)+
  geom_sf(data=SAN1.banks,fill="red",colour="red")

```

Several studies have linked the recruitment of sandeel in Area 1 to both demographic and environmental parameters. Arnott and Ruxton (2002) documented a link between recruitment at age zero, and the number of juveniles in the same area of age 1 via competition: large numbers of juvenile sandeel lead to reduced survival of recruits. Other authors have also demonstrated a link to the environment, both in terms of the abundance of food species (*Calanus finmarchicus*, *Temora longicornis*) and temperatures (Apr-June average SST) (van Deurs et al 2009; Lindegren et al 2018). All of these manuscripts have also shown links to adult spawning stock biomass. Here we validate and operationalise this knowledge to produce a forecast of sandeel recruitment in Area 1 of the North Sea.


## Basis for the Forecast 

|Component | Description                                                 |
-----------------|:-----------------------------------------------
Biological model | Statistical relationship between predictors and bias-corrected log-recruitment 
Environmental data set(s) | NOAA OISST v2 AVHRR-ony product (also known as Reynolds SST). https://www.ncdc.noaa.gov/oisst
Environmental variables| Sea-surface temperature averaged by quarter on the Area 1 spawning grounds (Figure 2), covering both the two quarters  prior to spawning of a year class and three quarters post-spawning.
Environmental forecast method | None. All environmental parameters are based on recent observations.
Additional variables| Demographic parameters of the stock, based on the most recent estimate from ICES, and bias corrected for retrospective assessment bias. 
Forecast lead time | `r lead.time` prior to the first official estimate of this year class strength from ICES.  |
Table: **Table 1. Overview of the basis for the forecast.**

The predictors employed can be broken down as follows:

* Sea surface temperatures
  + P3 - Jul-Sep temperatures experienced by the adults prior to spawning
  + P4 - Oct-Dec temperatures experienced by the adults prior to / during spawning
  + Q1 - Jan-Mar temperature experienced during egg development
  + Q2 - Apr-Jun temperature experienced by larvae during pelagic drift phase
  + Q3 - Jul-Sep temperature experienced by post-settlement juveniles
* Demographic parameters (as of 1 Jan)
  + logN1 - log of the numbers of juveniles (age 1)
  + logSumN - log of the total number of individuals in the population of Age 1 or greater
  + logTSB - log of the total stock biomass
  + logSSB - log of the spawnign stock biomass
* Other variables
  + Year - Cohort year, included to allow time-variation in the mean productivity of the stock due to systematic shifts in other unquantified variables

The forecast model is parameterised based on these explanatory varaibles by first fitting  all models that can be created by including / excluding the set of 10 explanatory variables (i.e. 1024 models). The small-sample corrected Akaike Information Criteria (AICc) for each model over the calibration period  is converted to an Akaike weight within the ensemble and then used to weight the individual predictions from each model when operating in forecast mode. 

Log recruitment is used as the response variable, with an additive structure for each explanatory term. All demographic parameters, including recruitment, are bias corrected prior to their use in the model. The logSSB and Year variables are represented by spline smoothers, with the maximum degrees of freedom associated with each spline constrained to be three or less. The models are fit using the mgcv and MuMIn packages in R.

The relative contribution of each explanatory variable to the model ensemble can be seen in Figure 3.

```{r Fig_RVI,fig.cap="**Figure 3. Relative Variable Importance in the model ensemble** *The relative variable importance (defined on a scale between 0 and 1 of each explanatory variable is shown for the model ensemble incorporating all data ie 1983-2017. These terms are however not constant, and can and do change over time. Terms fitted with a spline smoother are denoted by the s() term - all other terms are  linear.*"}
#Import model object
load(file.path("objects","models",mdl.sel))
mdl <-rev(mdls.l)[[1]]

#Get variable importance
rvi.v <- importance(mdl)
rvi.df <- tibble(var=names(rvi.v),
                 value=rvi.v) %>%
          mutate(var=gsub("^(s.*?),.*$","\\1)",var)) %>%
          arrange(var) 
          
ggplot(rvi.df)+
  geom_bar(aes(x=var,y=value),stat="identity")+
  labs(x="Variable",y="Relative variable importance")+
  theme(axis.text.x.bottom = element_text(angle = 90,hjust = 1))+
  coord_cartesian(ylim=c(0,1),expand=0)


```

Probabilistic forecasts were generated by based on the predictive distributions generated by the fitted models. Continuous values of log-recruitment were converted to terciles (high, medium and low) based on the  distribution of (bias-corrected) recruitment over the first 30 years (1983-2012) of the time series. Categorical forecasts were made by choosing the most likely value of the three terciles.

## Forecast Skill Assessment

Forecast skill was assessed in a situation that directly mimics the operational useage of this forecast system. The available data was first truncated at a cut-off year (e.g. 2000) and the empirical model described above was parameterised using all data up to and including this year (calibration period). The predictors available in the remaining part of the time series (validation period) were then used to make predictions for each year class. The process was then repeated for cut-off years from 2000 to 2016. Forecast skill was then evaluated by comparing the predicted values with the true (bias-corrected) recruitment values as a function of lead time.

Forecast skill was first evaluated by considering the number of times in which the model correctly predicts the recruitment category (i.e. high, medium or low recruitment). As a reference forecast, we choose random selection of each category with equal probability (i.e. 1/3).

```{r Skill_assessment_I, fig.cap="**Figure 4. Skill assessment across all categories.** *The overall skill of the recruitment forecast system in predicting each of high, medium, and low recruitments is shown as a function of forcecast lead time. Model skill is represented as the proportion of times in which the model correctly predicts the recruitment category (red line).  Points are marked according to the significance level of the result (NS=Non significant), relative to a reference forcast i.e. randomly choosing one of the three categories with equal probability: high significance levels indicates that the forecast model significantly outperforms the reference forecast at that lead time.  The cutoff for the 90% significance level is also shown as a dashed line. Forecast lead time is defined relative to the terminal year of the stock assessment.*"}
load("objects/Model_skill.RData")

prop.correct <- filter(cat.skill,model==gsub(".RData","",mdl.sel)) %>%
                mutate(p.level=pbinom(prop.correct*n,n,1/3),
                       p.thresh=cut(p.level,breaks = c(0,0.9,0.95,0.99,1),c("NS","p>90%","p>95%","p>99%")))

default.red <- scales::hue_pal()(3)[1]
ggplot(prop.correct,aes(lead,prop.correct)) + 
  geom_vline(xintercept = 0)+
  geom_line(aes(x=lead,y=(qbinom(0.90,n,1/3))/n,linetype="90% Signif."),colour="black")+
  geom_line(aes(linetype="Model"),col=default.red)+
  geom_point(aes(shape=p.thresh,colour=p.thresh),size=4)+
  scale_shape_manual(values=c(3,1,16,17))+
  #scale_colour_manual(values=c("black",scales::hue_pal()(3)[1]))+
  scale_colour_manual(values=c(default.red,"black",brewer.pal(3,"YlOrRd")[-1]))+
  scale_linetype_manual(values=c("dashed","solid"))+
  labs(linetype="Legend",colour="Significance",shape="Significance",
       x="Lead (relative to assessment year)",y="Proportion correct")+
  guides(linetype=guide_legend(override.aes = list(colour=c("black",default.red))))+
  coord_cartesian(xlim=c(-10,10),ylim=c(0,1),expand=FALSE)

```

This result shows that the forecast system significantly outperforms the reference forecast at the 95% level at leads one and two. 

It is also important to examine the forecast skill for each category, and its ability to correctly distinguish between the occurrence and absence of an event (and thus avoid false alarms). Forecast skill was therefore also measured using the so-called True Skill Score, TSS (also known as the Peirce Skill Score). The metric ranges between +1 and -1, with a value of 0 corresponding to random guessing (Figure 5).


```{r Skill_assessment_II, fig.cap="**Figure 5. Skill assessment by category.** *The skill of the recruitment forecast system in predicting each of high, medium, and low recruitments is shown as a function of forcecast lead time. Model skill is represented as the True (Peirce) Skill Score (TSS), which ranges between +1 and -1, and has a value of 1 for perfect skill, and 0 for random guessing (black dashed line). Forecast lead time is defined relative to the terminal year of the stock assessment. The  95% confidence interval for the estimated skill score at each lead time is plotted as the area area.*"}

tss.metrics <- dplyr::select(cat.skill,model,lead,starts_with("tss")) %>%
                gather("tercile","value",-model,-lead) %>%
                mutate(tercile=gsub("tss.","",tercile)) %>%
                separate(tercile,c("tercile","type")) %>%
                mutate(type=ifelse(is.na(type),"mean",type),
                       tercile=recode(tercile,
                                      high="a) High recruitment",
                                      med="b) Medium recruitment",
                                      low="c) Low recruitment")) %>%
                spread(key = "type",value = "value") %>%
                filter(model==gsub(".RData","",mdl.sel))

ggplot(tss.metrics,aes(lead,y=mean)) + 
  facet_wrap(tercile~. ,ncol=1)+
  geom_ribbon(aes(ymin=mean-1.96*se,ymax=mean+1.96*se),fill=default.red,colour=default.red)+
  geom_vline(xintercept = 0,colour="grey")+
  labs(col="Model",shape="Model",x="Lead (relative to assessment year)")+
  geom_hline(yintercept = 0,linetype="dashed")+
  geom_point()+geom_line()+
  labs(y="True Skill Score (TSS)",colour="Model")+
  guides(colour=FALSE,fill=FALSE)+
  coord_cartesian(xlim=c(-10,10),ylim=c(-1,1),expand = FALSE)

```

This result shows that our forecast system outperforms a reference forecast system at predicting high and low recruitments, but now at predicting medium recruitments. This should be bore in mind when interpreting the forecast.


## Quality Considerations

The forecast model used here is developed and evaluated against stock assessment data that has been corrected for the biases inherent in these estimates. The magnitude and variability of such biases can be estimated based on an analysis of the analytical retrospective pattern of the stock-assessment model (Payne 2019). This data is then used as the input to the forecasting model. However, it is important to note that the forecast made here is for the true (bias-corrected) recruitment in the ocean, rather than the value that will be generated by ICES (and subsequently used as the basis for scientific advice and management). The stock assessment typically over-estimates recruitment by a factor of around 80% in the terminal year, relative to the final converged value of the assessment, implying that the value returned by the assessment will be higher than that forecast here.

The skill of this forecast model has been evaluated in a realistic setting over the period 2001-2017. However, good historical forecast performance does not guarantee future forecast performance, and forecast skill can and does change over time. On the other hand, this forecast is based on a model parameterised over the full time-series of available data, and its performance should therefore be better than other models in the forecast evaluation scheme. It is important to note, none-the-less, that the reliability of any forecast scheme can only be evaluated over several iterations of use.

Various authors have highlighted the effect of *C. finmarchicus* and *T. longicornis* on recruitment to this species (van Deurs et al 2009; Lindegren et al 2018). However, it is not possible to include these variables in the forecasts due to the lag between collecting these samples and when they are first made available. However, exploratory analyses based on the subset of the data for which these variables are available have shown that they do not make major contributions to the forecast skill.


## For More Information

For more information, contact Mark R. Payne, DTU-Aqua, http://www.staff.dtu.dk/mpay. The latest version of this and other forecasts can be found on the website [fishforecasts.dtu.dk](http://fishforecasts.dtu.dk)  Code used to generate this forecast is available from the WGS2D GitHub repository, [https://github.com/ices-eg/wg_WGS2D](https://github.com/ices-eg/wg_WGS2D) in the directory "03_Sandeel_Recruitment_Forecast".

## References

* Arnott SA, Ruxton GD (2002) Sandeel recruitment in the North Sea: demographic, climatic and trophic effects. Mar Ecol Prog Ser 238:199–210

 * Christensen, A., Jensen, H., Mosegaard, H., St. John, M., & Schrum, C. (2008). Sandeel (Ammodytes marinus) larval transport patterns in the North Sea from an individual-based hydrodynamic egg and larval model. Canadian Journal of Fisheries and Aquatic Sciences, 65(7), 1498–1511. https://doi.org/10.1139/F08-073
 
* Lindegren, M., Van Deurs, M., MacKenzie, B. R., Worsoe Clausen, L., Christensen, A., & Rindorf, A. (2018). Productivity and recovery of forage fish under climate change and fishing: North Sea sandeel as a case study. Fisheries Oceanography, 27(3), 212–221. https://doi.org/10.1111/fog.12246

* Payne, M. (2019) Quantifying and correcting the retrospective pattern in fish stock assessments. ICES Journal of Marine Science. In Preparation.

* Rayner, N. A., Parker, D. E., Horton, E. B., Folland, C. K., Alexander, L. V., Rowell, D. P., … Kaplan, A. (2003). Global analyses of sea surface temperature, sea ice, and night marine air temperature since the late nineteenth century. Journal of Geophysical Research, 108(D14), 4407. https://doi.org/10.1029/2002JD002670
 
* Van Deurs, M., Van Hal, R., Tomczak, M. T., & Jónasdóttir, S. H. (2009). Recruitment of lesser sandeel Ammodytes marinus in relation to density dependence and zooplankton composition. Marine Ecology Progress Series, 381(Reay 1970), 249–258. https://doi.org/10.3354/meps07960

## Change Log

* 20181204 Full forecast sheet developed, with minor tweaks to the forecast model (switching from HadISST to OISST, and focusing on the specific banks, rather than all of Area 1).
* 20181113 Initial forecast for 2018 year class published via Twitter https://twitter.com/MarkPayneAtWork/status/1062287436586328065


## License Information

This work by Mark R. Payne is licensed under a  Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License. For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US Basically, this means that you are free to "share" and "remix" for non-commercial purposes as you see fit, so long as you "attribute" me for my contribution. Derivatives can be distributed under the same or similar license.

This work comes with ABSOLUTELY NO WARRANTY or support.

## Acknowledgements
The research leading to these results has received funding from the European Union Horizon 2020 research and innovation programme under grant agreement number 727852 (Blue-Action). 

<!-- ![](../../common/blue-action-logo.png)  -->
![](../resources/blue-action-logo.png)







