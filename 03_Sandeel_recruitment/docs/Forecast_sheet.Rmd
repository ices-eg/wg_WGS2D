---
title: "Sandeel Recruitment Forecast"
subtitle: 'Fishforecasts Forecast sheet 03-20181204'
output:
  html_document: 
    fig_caption: yes
    outputfile: test.html
  word_document: 
    fig_caption: yes
    reference_docx: "../resources/word-styles-reference.docx"
---

```{r setup, include="FALSE"}
this.issue <- "17-09-2018"
#Clean plate
rm(list=ls())

#Configure Knitr
knitr::opts_chunk$set(
  echo=FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	results = "markup",
	fig.width = 10,
	fig.height=14/25*10,
  fig.align="center",
  fig.path=file.path(".","figures","Forecast_sheet_"))

# knitr::opts_knit$set(
#   root.dir="..")

library(tidyverse)
library(ggplot2)
library(tibble)
library(tidyverse)
library(RColorBrewer)
library(sf)
library(mapdata)
library(MuMIn)
library(gridExtra)
library(viridis)

#Inline strings
forecast.yr <- 2019
norm.fact <- 1e6
most.recent.data <- "September 2019"
lead.time <- "2 months"
#Configuration
theme_set(theme_bw(base_size = 14))
```

```{r}
cfgs.l <- list(
  "src/B.Configuration/B1.Sandeel_area1.r",
  "src/B.Configuration/B2.Sandeel_area2.r",
  "src/B.Configuration/B3.Sandeel_area3.r",
  "src/B.Configuration/B4.Sandeel_area4.r"
)
```
Issued 17-09-2019. Valid through to 01-04-2020. 

Prepared by Mark R. Payne, DTU Aqua, Copenhagen, Denmark and Christian Kiær, DTU Aqua, Copenhagen Denmark(?).

<!-- This forecast sheet superceeds the previous version 01-v02.1, issued 17-01-2018. For details, see the Change Log at the bottom of this document. -->

This is a preliminary forecast of the 2019 cohort strength for all North Sea sandeel stocks and supersedes the single stock 2018 forecast released via fishforecast.dtu.dk on 4th of December 2018.

## Forecast
The 2019 forecast of sandeel recruitment includes a categorical forecast for multiple management areas and a portfolio forecast for the North Sea. Only the management areas with sufficient data are forecasted (1r, 2r, 3r and 4), while the portfolio forecast includes information from each of the individual forecasts. The categorical forecast, based on terciles (low, medium and high) from the historically observed recruitment, indicates the probability of the current year class strength falling into a given category.

All individual forecasts suggests a low probability of a strong year class (5% to 25%), with a high probability of this year class being in the lower third of the historically observed recruitment (between 45% and 65%) (Figure 1). 

The portfolio forecast also shows low probability of a strong overall year class (15%), but shows an almost equal probability of a low (lower third) or medium (medium third) 2019 recruitment year (40% to 45%).
```{r Fig_Forecast,fig.cap="**Figure 1. Recruitment forecast for 2019 for 4 individual management areas and an aggregated portfolio forecast using information from all individual forecasts.** *Management area 1r, 2r, 3r and 4 are shown together with the portfolio forecast. The probabilities of the 2019 year class falling in each of the three terciles (high, medium or low recruitment) are plotted as horizontal bars. All individual stocks suggests a recruitment in the lower thirds of the historically observed values, while the portfolio forecast shows equal probabilities of low and medium. No forecast indicates a high probability of a high recruitment. Tercile thresholds are based on the values from the complete time series for a given forecast area.*", dpi=300}
#'========================================================================
# Setup ####
#'========================================================================
load("objects/Forecast_sheet_metrics.RData")
order <- c("Area 1r", "Area 2r", "Area 3r", "Area 4", "Portfolio")
order.t <- c("High", "Medium", "Low")
#terc.labels <- arrange(terc.labels, match(model, c("Sandeel Area 1", "Sandeel Area 2", "Sandeel Area 3", "Sandeel Area 4", "Portfolio")))
terc.labels <- arrange(transform(terc.labels,
             model=factor(model,levels=order)),model)
tss.metrics <- arrange(transform(tss.metrics,
             model=factor(model,levels=order)),model)
prop.correct <- arrange(transform(prop.correct,
             model=factor(model,levels=order)),model)

tss.metrics <- arrange(transform(tss.metrics, 
                                  tercile=factor(tercile, levels=order.t), tercile))
# prop.correct <- arrange(transform(prop.correct, 
#                                  tercile=factor(tercile, levels=order.t), tercile))

#'========================================================================
# Visualise forecasts ####
#'========================================================================
ggplot()+
  geom_bar(data=terc.labels,aes(x=lbl, y=prob.lbl, fill=lbl), colour="black", stat = "identity", width = 1, position = position_stack(reverse = TRUE))+
  geom_text(data=terc.labels,aes(x=lbl,y=prob.lbl+20, label=paste0(prob.lbl, "%")))+
  scale_fill_brewer(palette = "BrBG") +
  coord_flip(ylim = c(0,100)) +
  facet_wrap(~model, ncol=5) +
  scale_x_discrete(limits = rev(levels(terc.labels$lbl))) +
  labs(title = "2019 Sandeel recruitment forecast", x = "Recruitment terciles", y = "Probability [%]", fill="")+
  theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(), 
        panel.grid.minor.x = element_blank(), legend.position = "none")
```


## Background

Lesser sandeel (<i>Ammodytes marinus</i>) in the North Sea form the basis for a commercially important fishery, where they are used in the production of fishoil and fishmeal. The species lives on sandy banks distributed throughout the North Sea: while the adults are typically bound to a specific bank, larval sandeel are pelagic and drift between banks. Particle tracking studies (Christensen et al 2008) have characterised this connectivity pattern and form the basis for the definition of seven management units. Four management areas are not considered data poor and can be included in the forecast (Figure 2).
```{r Fig_Banks,fig.cap="**Figure 2. Sandeel areas and banks in the North Sea.** *Sandeel management areas outlined, with the habitat banks marked in gray within each area.*", echo=FALSE,results='hide',fig.keep='all', dpi=300}
#source("src/B.Configuration/B2.Sandeel_area2.r")
load("objects/configuration.RData")

st_crs(pcfg@polys) <- st_crs(pcfg@banks.sf)
#cords <- c()
ggplot()+
  geom_sf(data=pcfg@polys,fill=NA)+
  annotation_map(map_data("worldHires"),fill="gray")+
  geom_sf(data=pcfg@banks.sf) +
  geom_text(aes(x=4.5,y=54.7, label="1r"), size=10) +
  geom_text(aes(x=9.2,y=55.7, label="2r"), size=10) +
  geom_text(aes(x=3.8,y=58.4, label="3r"), size=10) +
  geom_text(aes(x=-1,y=58.4, label="4"), size=10)

  #geom_sf(data=pcfg@spatial.domains,fill="red",colour="red")

```

Several studies have linked the recruitment of sandeel in Area 1 to both demographic and environmental parameters. Arnott and Ruxton (2002) documented a link between recruitment at age zero, and the number of juveniles in the same area of age 1 via competition: large numbers of juvenile sandeel lead to reduced survival of recruits. Other authors have also demonstrated a link to the environment, both in terms of the abundance of food species (*Calanus finmarchicus*, *Temora longicornis*) and temperatures (Apr-June average SST) (van Deurs et al 2009; Lindegren et al 2018). All of these manuscripts have also shown links to adult spawning stock biomass.  Here we validate and operationalise this knowledge to produce individual forecasts of sandeel recruitment in management areas 1r, 2r, 3r and 4 in the North Sea. The individual forecasts is aggregated into a single portfolio forecast, which can increase the predictability of the overall recruitment across the chosen management areas.

## Basis for the Forecast 

|Component | Description                                                 |
-----------------|:-----------------------------------------------
Biological model | Statistical relationship between predictors and log-recruitment 
Environmental data set(s) | NOAA OISST v2 AVHRR-ony product (also known as Reynolds SST). https://www.ncdc.noaa.gov/oisst
Environmental variables| Sea-surface temperature averaged by quarter on the sandeel habitat banks (Figure 2), covering both the two quarters  prior to spawning of a year class and four quarters post-spawning.
Environmental forecast method | None. All environmental parameters are based on recent observations.
Additional variables| Demographic parameters of the stock, based on the most recent estimate from ICES.
Forecast lead time | `r lead.time` prior to the first official estimate of this year class strength from ICES.  |
Table: **Table 1. Overview of the basis for the forecast.**

The predictors employed can be broken down as follows:

* Sea surface temperatures
  + P3 - Jul-Sep temperatures experienced by the adults prior to spawning
  + P4 - Oct-Dec temperatures experienced by the adults prior to / during spawning
  + Q1 - Jan-Mar temperature experienced during egg development
  + Q2 - Apr-Jun temperature experienced by larvae during pelagic drift phase
  + Q3 - Jul-Sep temperature experienced by post-settlement juveniles
  + Q4 - Oct-Dec temperature experienced by post-settlement juveniles
* Demographic parameters (as of 1 Jan)
  + logN1 - log of the numbers of juveniles (age 1)
  + logSumN - log of the total number of individuals in the population of Age 1 or greater
  + logTSB - log of the total stock biomass
  + logSSB - log of the spawnign stock biomass
* Other variables
  + Year - Cohort year, included to allow time-variation in the mean productivity of the stock due to systematic shifts in other unquantified variables

The forecast model is parameterised based on these explanatory variables by first fitting all models that can be created by including / excluding the set of 11 explanatory variables. To avoid collinearity a model can only include one environmental and one additional demographic variable besides logSSB. The small-sample corrected Akaike Information Criteria (AICc) for each model over the calibration period is converted to an Akaike weight within the ensemble and then used to weight the individual predictions from each model when operating in forecast mode.

Log recruitment is used as the response variable, with an additive structure for each explanatory term. The logSSB and Year variables are represented by spline smoothers, with the maximum degrees of freedom associated with each spline constrained to be three or less. The models are fit using the mgcv and MuMIn packages in R.

The relative contribution of each explanatory variable group (e.g. demographic and environmental) to the model ensemble for each individual forecast area can be seen in Figure 3.

```{r Fig_RVI,fig.cap="**Figure 3. Relative Variable Importance in the model ensemble for each area** *The relative variable importance (defined on a scale between 0 and 1 of each explanatory variable is shown for the model ensemble incorporating all data e.g. 1983-2018. These terms are however not constant, and can and do change over time. Terms fitted with a spline smoother are denoted by the s() term - all other terms are linear.*", , dpi=300}
rvi.df.w <- spread(rvi.df, var, value)

rvi.df.w <- rvi.df.w %>%
  mutate(Environment = P3+P4+Q1+Q2+Q3+Q4, Demography=logN1+logSumN+logTSB) %>%
  dplyr::select(-P3,-P4,-Q1,-Q2,-Q3,-Q4,-logN1,-logSumN,-logTSB)

rvi.df.l <- gather(rvi.df.w, key = "var", val = "Value", "s(logSSB)", "s(Year)", Environment, Demography)

ggplot(rvi.df.l)+
  geom_bar(aes(x=var,y=Value, fill=model),stat="identity", position = position_dodge(width=0.8), colour="black", width = 0.7)+
  scale_fill_brewer(palette = "Set2") +
  labs(x="Variable",y="Relative variable importance")+
  theme(axis.text.x.bottom = element_text(angle = 90,hjust = 1))+
  coord_cartesian(ylim=c(0,1.02),expand=TRUE)+
  scale_x_discrete(expand = c(0,0.6))+
  scale_y_continuous(expand = c(0,0))+
  labs(fill = "Area")


```

Probabilistic forecasts were generated by based on the predictive distributions generated by the fitted models. Continuous values of log-recruitment were converted to terciles (high, medium and low) based on the distribution of recruitment over the full historical time series. Categorical forecasts were made by choosing the most likely value of the three terciles.

## Forecast Skill Assessment

Forecast skill was assessed in a situation that directly mimics the operational usage of this forecast system. The available data was first truncated at a cut-off year (e.g. 2006) and the empirical model described above was parameterised using all data up to and including this year (calibration period). The predictors available in the remaining part of the time series (validation period) were then used to make predictions for each year class. The process was then repeated for cut-off years from 2006 to 2018. Forecast skill was then evaluated by comparing the predicted values with the true recruitment values as a function of lead time.

In an operational setting the predictions consists of the current assessment years (lead time of 0) recruitment. For this reason, when doing retrospective forecasts, skill evaluation is presented for lead 0 specifically. Skill is evaluated for all chosen management areas and the portfolio forecast.

Forecast skill was first evaluated by considering the number of times in which the model correctly predicts the recruitment category (i.e. high, medium or low recruitment) (Figure 4). As a reference forecast, we choose random selection of each category with equal probability (i.e. 1/3).

```{r Skill_assessment_I, fig.cap="**Figure 4. Skill assessment across all categories for each forecast.** *The overall skill of the recruitment forecast system in predicting each of high, medium, and low recruitments is shown for a lead time of 0. Model skill is represented as the proportion of times in which the model correctly predicts the recruitment category (shown in percentage). The proportion correct is shown for all individual management areas and the portfolio forecast. The cut-off for the 95% significance level is also shown as a dashed line.*", dpi=300}
prop.correct$prop.correct <- prop.correct$prop.correct*100
ggplot()+
  geom_bar(data=prop.correct,aes(x=model, y=prop.correct, fill=model),colour="black", stat = "identity", width = 0.6)+
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(expand = c(0,0))+
  scale_x_discrete(expand = c(0,0.5))+
  #coord_flip(ylim = c(0,100)) +
  coord_cartesian(ylim=c(0,100), expand = TRUE) +
  geom_hline(data=prop.correct, aes(yintercept=((qbinom(0.95,n,1/3))/n)*100, linetype="95% Signif."))+
  scale_linetype_manual(name = "Significance", values = 3,
                      guide = guide_legend(override.aes = list(color = ("black"))))+
  labs(y = "Proportion correct [%]", x = "", fill="Area") +
  geom_vline(data=prop.correct, aes(xintercept=4.5), linetype="solid", colour="black", size=0.4) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(), legend.position = "none")

```

This result shows that at lead 0 the forecast system significantly outperforms the reference forecast at the 95% level for all management areas and the portfolio forecast. The portfolio forecast has the highest correct hit rate reaching almost 70%. Area 1r shows the best performance of the individual forecasts (just over 60% hit rate), with area 2r, 3r and 4 all reaching above 50% hit rate.

It is also important to examine the forecast skill for each category, and its ability to correctly distinguish between the occurrence and absence of an event (and thus avoid false alarms). Forecast skill was therefore also measured using the so-called True Skill Score, TSS (also known as the Peirce Skill Score). The metric ranges between +1 and -1, with a value of 0 corresponding to random guessing (Figure 5).


```{r Skill_assessment_II, fig.cap="**Figure 5. Skill assessment by category.** *(a) The skill of the recruitment forecast system in predicting each of high, medium, and low recruitments is shown at lead time of 0 for all individual areas and the portfolio forecast. (b) The skill shown according to recruitment terciles is shown for lead 0. Model skill is represented as the True (Peirce) Skill Score (TSS), which ranges between +1 and -1, and has a value of 1 for perfect skill, and 0 for random guessing (black dashed line). The 95% confidence interval for the estimated skill score are shown as error bars on each of the points.*", dpi=300}
tss.metrics <- tss.metrics %>%
  mutate(Tercile=tercile) %>%
  mutate(Area=gsub("Area ", "", model))

tss1 <- ggplot(data=tss.metrics,aes(x=model, y=mean, colour=Tercile, group=Tercile, shape=Tercile))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, position=position_dodge(width = 0.5), linetype="solid", colour="black")+
  #geom_point(aes(), size=5, position=position_dodge(width = 0.5), colour="black") +
  geom_point(aes(fill=Tercile), size=3, position=position_dodge(width = 0.5), colour="black") +
  scale_shape_manual(values=c(21, 22, 24))+
  scale_colour_brewer(palette = "BrBG") +
  scale_y_continuous(expand = c(0,0))+
  scale_fill_brewer(palette = "BrBG") +
  coord_cartesian(ylim = c(-1,1)) +
  #facet_wrap(tercile~., ncol=1) +
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  labs( x= "Area", y = "True Skill Score (TSS)")+
  geom_vline(xintercept=c(1.5,2.5,3.5,4.5), colour="grey")+
  theme(legend.position="bottom", panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_text(aes(x=0.6,y=0.9, label="a)"), colour="black")


tss2 <- ggplot(data=tss.metrics,aes(x=Tercile, y=mean, colour=Area, shape = Area))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, position=position_dodge(width = 0.5), linetype="solid", colour="black")+ 
  geom_point(aes(fill=Area), size=3, position=position_dodge(width = 0.5), colour="black") +
  scale_shape_manual(values=c(21, 22, 23, 24, 25))+
  guides(fill="legend")+
  scale_colour_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(-1,1)) +
  scale_y_continuous(labels = rep("", 5), breaks = seq(-1,1,.5), expand = c(0,0))+
  #scale_x_discrete(minor_breaks = seq(1.5, 4.5, 1)) +
  #facet_wrap(tercile~., ncol=1) +
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  labs( x= "Recruitment tercile", y = "") +
  geom_vline(xintercept=c(1.5,2.5), colour="grey")+
  theme(legend.position="bottom", panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_text(aes(x=0.6,y=0.9, label="b)"), colour="black")
  
grid.arrange(tss1, tss2, ncol=2)
```

This result shows that we see large differences between areas, with only area 1r and the portfolio forecast outperforming random guessing in all terciles. Area 2r and 3r shows indications of being unable to correctly distinguishing between events (Figure 5a). The models are generally best at correctly predicting high and low, while the skill in the medium terciles is lower (Figure 5b). This should be bore in mind when interpreting the forecast.

## Quality Considerations

The skill of this forecast model has been evaluated in a realistic setting over the period 2006-2018. However, good historical forecast performance does not guarantee future forecast performance, and forecast skill can and does change over time. On the other hand, this forecast is based on a model parameterised over the full time-series of available data, and its performance should therefore be better than other models in the forecast evaluation scheme. It is important to note, none-the-less, that the reliability of any forecast scheme can only be evaluated over several iterations of use.

Various authors have highlighted the effect of *C. finmarchicus* and *T. longicornis* on recruitment to this species (van Deurs et al 2009; Lindegren et al 2018). However, it is not possible to include these variables in the forecasts due to the lag between collecting these samples and when they are first made available. However, exploratory analyses based on the subset of the data for which these variables are available have shown that they do not make major contributions to the forecast skill.


## For More Information

For more information, contact Mark R. Payne, DTU-Aqua, http://www.staff.dtu.dk/mpay. The latest version of this and other forecasts can be found on the website [fishforecasts.dtu.dk](http://fishforecasts.dtu.dk)  Code used to generate this forecast is available from the WGS2D GitHub repository, [https://github.com/ices-eg/wg_WGS2D](https://github.com/ices-eg/wg_WGS2D) in the directory "03_Sandeel_Recruitment_Forecast".

## References

* Arnott SA, Ruxton GD (2002) Sandeel recruitment in the North Sea: demographic, climatic and trophic effects. Mar Ecol Prog Ser 238:199–210

 * Christensen, A., Jensen, H., Mosegaard, H., St. John, M., & Schrum, C. (2008). Sandeel (Ammodytes marinus) larval transport patterns in the North Sea from an individual-based hydrodynamic egg and larval model. Canadian Journal of Fisheries and Aquatic Sciences, 65(7), 1498–1511. https://doi.org/10.1139/F08-073
 
* Lindegren, M., Van Deurs, M., MacKenzie, B. R., Worsoe Clausen, L., Christensen, A., & Rindorf, A. (2018). Productivity and recovery of forage fish under climate change and fishing: North Sea sandeel as a case study. Fisheries Oceanography, 27(3), 212–221. https://doi.org/10.1111/fog.12246

* Payne, M. (2019) Quantifying and correcting the retrospective pattern in fish stock assessments. ICES Journal of Marine Science. In Preparation.

* Rayner, N. A., Parker, D. E., Horton, E. B., Folland, C. K., Alexander, L. V., Rowell, D. P., … Kaplan, A. (2003). Global analyses of sea surface temperature, sea ice, and night marine air temperature since the late nineteenth century. Journal of Geophysical Research, 108(D14), 4407. https://doi.org/10.1029/2002JD002670
 
* Van Deurs, M., Van Hal, R., Tomczak, M. T., & Jónasdóttir, S. H. (2009). Recruitment of lesser sandeel Ammodytes marinus in relation to density dependence and zooplankton composition. Marine Ecology Progress Series, 381(Reay 1970), 249–258. https://doi.org/10.3354/meps07960

## Change Log

* 20181204 Full forecast sheet developed, with minor tweaks to the forecast model (switching from HadISST to OISST, and focusing on the specific banks, rather than all of Area 1).
* 20181113 Initial forecast for 2018 year class published via Twitter https://twitter.com/MarkPayneAtWork/status/1062287436586328065


## License Information

This work by Mark R. Payne is licensed under a  Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License. For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US Basically, this means that you are free to "share" and "remix" for non-commercial purposes as you see fit, so long as you "attribute" me for my contribution. Derivatives can be distributed under the same or similar license.

This work comes with ABSOLUTELY NO WARRANTY or support.

## Acknowledgements
The research leading to these results has received funding from the European Union Horizon 2020 research and innovation programme under grant agreement number 727852 (Blue-Action). 

<!-- ![](../../common/blue-action-logo.png)  -->
![](../resources/blue-action-logo.png)







